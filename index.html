<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário MailerLite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte principal para o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Centraliza o conteúdo na página */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Garante que ocupe a altura total da viewport */
            padding: 1rem; /* Adiciona algum preenchimento */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- MailerLite Universal -->
    <script>
        (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
        .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
        n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
        (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
        ml('account', '1404722');
    </script>
    <!-- End MailerLite Universal -->

</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 text-white selection:bg-sky-500 selection:text-white">

    <div class="container mx-auto p-6 bg-slate-800 shadow-2xl rounded-xl max-w-2xl w-full">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-400">Assine nossa Newsletter!</h1>
            <p class="text-slate-400 mt-2">Receba as últimas novidades e dicas diretamente na sua caixa de entrada.</p>
        </header>

        <!-- MailerLite Form -->
        <section id="mailerliteFormSection" class="mt-8 text-center w-full">
            <div class="ml-embedded" data-form="tAmK3E"></div>
        </section>
        <!-- End MailerLite Form -->
    </div>

    <!-- Script para detectar o envio do formulário MailerLite e empurrar dados para o dataLayer -->
    <script>
      // Função para empurrar os dados do formulário para o dataLayer
      function pushMailerLiteData(formEvent) {
        try {
          var form = formEvent.target;
          var formData = new FormData(form);

          // Captura os valores dos campos do formulário.
          // ATENÇÃO: Verifique os atributos 'name' dos seus campos no HTML do formulário MailerLite.
          // Por exemplo, se o campo de email tiver name="email_address", você mudaria 'fields[email]' para 'email_address'.
          var email = formData.get('fields[email]'); // Nome padrão do campo de email do MailerLite
          var name = formData.get('fields[name]');   // Nome padrão do campo de nome do MailerLite
          var phone = formData.get('fields[phone]'); // Nome padrão do campo de telefone do MailerLite (se você tiver um)

          // Tenta obter o user_id do dataLayer.
          // Presume que a sua Stape Data Tag já colocou o user_id no dataLayer com o evento 'initial_visit_data'.
          // Isso é crucial para conectar o envio do formulário com a visita inicial.
          var userId = '';
          if (window.dataLayer) {
            for (var i = 0; i < window.dataLayer.length; i++) {
              var item = window.dataLayer[i];
              if (item && item.user_id && item.event === 'initial_visit_data') {
                userId = item.user_id;
                break; // Encontrou o user_id, pode sair do loop
              }
            }
          }

          // Empurra o evento personalizado e os dados para o dataLayer
          window.dataLayer.push({
            event: 'mailerlite_form_submit', // Nome do evento que você usará como trigger no GTM
            form_name: 'MailerLite Subscription', // Nome descritivo para este formulário
            form_email: email,
            form_name_field: name, // Adapte se precisar de mais campos ou nomes diferentes
            form_phone_field: phone, // Adapte se precisar de mais campos ou nomes diferentes
            user_id_on_submit: userId // O user_id associado a este envio do formulário
          });

          console.log('MailerLite form submitted and data pushed to dataLayer:', {
            form_email: email,
            form_name_field: name,
            form_phone_field: phone,
            user_id_on_submit: userId
          });

        } catch (e) {
          console.error('Erro ao empurrar dados do formulário MailerLite para o dataLayer:', e);
        }
      }

      // MutationObserver para detectar quando o formulário MailerLite é adicionado ao DOM.
      // Isso é necessário porque o MailerLite injeta o formulário dinamicamente.
      var observer = new MutationObserver(function(mutationsList, observer) {
        for (var i = 0; i < mutationsList.length; i++) {
          var mutation = mutationsList[i];
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            for (var j = 0; j < mutation.addedNodes.length; j++) {
              var node = mutation.addedNodes[j];
              // Verifica se o nó adicionado é um elemento HTML e contém um formulário MailerLite
              // O seletor 'form[data-ml-form]' é baseado na estrutura comum dos formulários MailerLite.
              if (node.nodeType === 1 && node.querySelector && node.querySelector('form[data-ml-form]')) {
                var mailerLiteForm = node.querySelector('form[data-ml-form]');
                if (mailerLiteForm) {
                  // Adiciona o event listener para o evento 'submit' do formulário
                  mailerLiteForm.addEventListener('submit', pushMailerLiteData);
                  console.log('Formulário MailerLite detectado e listener de submit adicionado.');
                  observer.disconnect(); // Desconecta o observer uma vez que o formulário é encontrado e o listener é adicionado
                  return; // Sai da função após desconectar o observer
                }
              }
            }
          }
        }
      });

      // Começa a observar o corpo do documento para mudanças nos filhos e subárvores.
      observer.observe(document.body, { childList: true, subtree: true });

      // Fallback: Caso o formulário já esteja presente no DOM no carregamento inicial da página (menos comum para MailerLite)
      document.addEventListener('DOMContentLoaded', function() {
        var existingMailerLiteForm = document.querySelector('form[data-ml-form]');
        if (existingMailerLiteForm) {
          existingMailerLiteForm.addEventListener('submit', pushMailerLiteData);
          console.log('Formulário MailerLite encontrado em DOMContentLoaded e listener adicionado.');
          observer.disconnect();
        }
      });

    </script>

</body>
</html>
