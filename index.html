<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário MailerLite com DataLayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .ml-embedded {
            max-width: 400px;
            width: 100%;
            padding: 20px;
            background-color: #f6f6f6;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #333;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Tag Manager (coloque aquí su GTM ID) -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-XXXXXXX');</script>
    <!-- Fin Google Tag Manager -->
    
    <script>
        (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
        .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
        n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
        (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
        ml('account', '1404722');
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 text-white selection:bg-sky-500 selection:text-white">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- Fin Google Tag Manager (noscript) -->

    <div class="container mx-auto p-6 bg-slate-800 shadow-2xl rounded-xl max-w-2xl w-full">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-400">Assine nossa Newsletter!</h1>
            <p class="text-slate-400 mt-2">Receba as últimas novidades e dicas diretamente na sua caixa de entrada.</p>
        </header>

        <section id="mailerliteFormSection" class="mt-8 text-center w-full">
            <div class="ml-embedded" data-form="fnu5le"></div>
        </section>
    </div>

<script>
    // Inicializar dataLayer antes de cualquier otra cosa
    window.dataLayer = window.dataLayer || [];
    
    // Función para generar UUID
    function generateUUID() {
        return crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Función para obtener cookies
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';')[0];
        return null;
    }

    // Función para obtener parámetros URL
    function getURLParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Función para enviar evento al dataLayer con debug
    function pushToDataLayer(data) {
        console.log('Enviando al dataLayer:', data);
        window.dataLayer.push(data);
        
        // Verificar que el evento se agregó correctamente
        console.log('Estado actual del dataLayer:', window.dataLayer);
        
        // Disparar evento personalizado adicional para asegurar detección
        setTimeout(() => {
            window.dataLayer.push({
                'event': 'custom_lead_submit',
                'form_name': 'newsletter_signup',
                'timestamp': new Date().toISOString()
            });
        }, 100);
    }

    // Cuando el formulario se carga
    document.addEventListener('ml-embedded:form:load', function(event) {
        console.log('Formulário MailerLite carregado');
        
        try {
            const hiddenField = document.querySelector('input[name="fields[event_id_hidden]"]');
            if (hiddenField) {
                const newUUID = generateUUID();
                hiddenField.value = newUUID;
                console.log('Campo oculto event_id preenchido com:', newUUID);
            } else {
                console.warn("Campo oculto 'fields[event_id_hidden]' não encontrado");
            }
        } catch(e) {
            console.error('Erro ao preencher campo oculto:', e);
        }
    });

    // Cuando el formulario se envía exitosamente
    document.addEventListener('ml-embedded:form:success', function(event) {
        console.log('Formulário enviado com sucesso! Event detail:', event.detail);
        
        try {
            const data = event.detail.data;
            const eventId = data.fields.event_id_hidden || generateUUID();
            
            // Obtener datos de tracking
            const fbp = getCookie('_fbp');
            const fbc = getCookie('_fbc');
            const gclid = getURLParam('gclid');
            const utmSource = getURLParam('utm_source');
            const utmMedium = getURLParam('utm_medium');
            const utmCampaign = getURLParam('utm_campaign');

            // Preparar payload para dataLayer
            const dataLayerPayload = {
                'event': 'form_submit',
                'form_id': 'mailerlite_newsletter',
                'form_name': 'Newsletter Signup',
                'event_id': eventId,
                'user_email': data.fields.email || '',
                'user_phone': data.fields.phone || null,
                'lead_data': {
                    email: data.fields.email || '',
                    phone: data.fields.phone || null,
                    source: 'mailerlite_form'
                },
                'tracking_data': {
                    fbp: fbp,
                    fbc: fbc,
                    gclid: gclid,
                    utm_source: utmSource,
                    utm_medium: utmMedium,
                    utm_campaign: utmCampaign,
                    user_agent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                }
            };

            // Limpiar valores null/undefined
            Object.keys(dataLayerPayload).forEach(key => {
                if (dataLayerPayload[key] === null || dataLayerPayload[key] === undefined) {
                    delete dataLayerPayload[key];
                }
            });

            // Enviar al dataLayer
            pushToDataLayer(dataLayerPayload);

            // Evento adicional para Facebook Pixel y Google Ads
            setTimeout(() => {
                pushToDataLayer({
                    'event': 'generate_lead',
                    'event_id': eventId,
                    'value': 1,
                    'currency': 'USD',
                    'email': data.fields.email || ''
                });
            }, 200);

            // Mostrar mensaje de éxito
            console.log('Todos os eventos enviados para o dataLayer com sucesso!');
            
        } catch (error) {
            console.error('Erro ao processar envio do formulário:', error);
        }
    });

    // Debug: Mostrar estado inicial del dataLayer
    console.log('DataLayer inicial:', window.dataLayer);
    
    // Test de conectividad con GTM
    setTimeout(() => {
        if (typeof google_tag_manager !== 'undefined') {
            console.log('Google Tag Manager detectado e funcionando');
        } else {
            console.warn('Google Tag Manager não detectado - verifique se o GTM está instalado corretamente');
        }
    }, 2000);
</script>

</body>
</html>
