<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário MailerLite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte principal para o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Centraliza o conteúdo na página */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Garante que ocupe a altura total da viewport */
            padding: 1rem; /* Adiciona algum preenchimento */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- MailerLite Universal -->
    <script>
        (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
        .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
        n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
        (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
        ml('account', '1404722');

        // Função para obter o ID único da cookie (igual ao seu Passo 1)
        function getUniqueTrackingIdFromCookie() {
            var cookieName = '_mi_id_seguimiento'; // <<-- ¡Asegúrate que este nombre coincida con tu Paso 1!
            var cookieValue = '';
            var cookies = document.cookie.split('; ');
            for(var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.indexOf(cookieName + '=') === 0) {
                    cookieValue = cookie.substring(cookieName.length + 1);
                    break;
                }
            }
            return cookieValue;
        }
    </script>
    <!-- End MailerLite Universal -->

</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 text-white selection:bg-sky-500 selection:text-white">

    <div class="container mx-auto p-6 bg-slate-800 shadow-2xl rounded-xl max-w-2xl w-full">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-400">Assine nossa Newsletter!</h1>
            <p class="text-slate-400 mt-2">Receba as últimas novidades e dicas diretamente na sua caixa de entrada.</p>
        </header>

        <!-- MailerLite Form -->
        <section id="mailerliteFormSection" class="mt-8 text-center w-full">
            <div class="ml-embedded" data-form="tAmK3E"></div>
        </section>
        <!-- End MailerLite Form -->
    </div>

    <script>
        // Esperar a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            const uniqueId = getUniqueTrackingIdFromCookie();

            if (uniqueId) {
                // Función para intentar llenar el campo oculto de MailerLite
                function fillMailerLiteHiddenField() {
                    // MailerLite a menudo nombra los campos ocultos de una manera predecible,
                    // como 'fields[custom_field_ID]' o 'fields[nombre_del_campo_personalizado]'.
                    // También es posible que el formulario se incruste dentro de un iframe.

                    // Primero, intenta encontrar el input por el nombre exacto de tu campo personalizado 'unique_tracking_id'
                    // Este es el selector más probable si no está en un iframe o si MailerLite genera el name así.
                    let hiddenField = document.querySelector('input[name="fields[unique_tracking_id]"]');

                    if (!hiddenField) {
                        // Si no lo encuentra directamente, es posible que esté dentro de un iframe.
                        // MailerLite usa un iframe para su formulario incrustado '.ml-embedded'
                        const mlIframe = document.querySelector('.ml-embedded iframe');
                        if (mlIframe && mlIframe.contentDocument) {
                            hiddenField = mlIframe.contentDocument.querySelector('input[name="fields[unique_tracking_id]"]');
                        }
                    }

                    if (hiddenField) {
                        hiddenField.value = uniqueId;
                        console.log('ID Único insertado en campo oculto de MailerLite:', uniqueId);
                        return true; // Campo encontrado y llenado
                    } else {
                        console.warn('Campo oculto de MailerLite para unique_tracking_id no encontrado todavía.');
                        return false; // Campo no encontrado
                    }
                }

                // Intenta llenar el campo, repitiendo cada cierto tiempo si no lo encuentra.
                // Esto es porque el formulario de MailerLite se carga dinámicamente.
                let attempts = 0;
                const maxAttempts = 20; // Intentar hasta 20 veces
                const intervalTime = 500; // Cada 0.5 segundos

                const checkInterval = setInterval(() => {
                    if (fillMailerLiteHiddenField() || attempts >= maxAttempts) {
                        clearInterval(checkInterval); // Detener el intento si se llena o si se alcanzan los intentos máximos
                    }
                    attempts++;
                }, intervalTime);

            } else {
                console.warn('Cookie de ID Único no encontrada. Asegúrate de que el script de generación de ID esté funcionando.');
            }
        });
    </script>
</body>
</html>
