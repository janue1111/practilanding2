<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário MailerLite com DataLayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .ml-embedded {
            max-width: 400px;
            width: 100%;
            padding: 20px;
            background-color: #f6f6f6;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #333;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- MailerLite Universal -->
    <script>
        (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
        .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
        n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
        (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
        ml('account', '1404722');
    </script>
    <!-- End MailerLite Universal -->
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 text-white selection:bg-sky-500 selection:text-white">

    <div class="container mx-auto p-6 bg-slate-800 shadow-2xl rounded-xl max-w-2xl w-full">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-400">Assine nossa Newsletter!</h1>
            <p class="text-slate-400 mt-2">Receba as últimas novidades e dicas diretamente na sua caixa de entrada.</p>
        </header>

        <!-- 
          INSTRUÇÕES IMPORTANTES PARA O FORMULÁRIO MAILERLITE:
          1. O script abaixo funcionará com os nomes de campo padrão do MailerLite (`email`, `name`).
          2. Se você tiver um campo de telefone, certifique-se de que o nome do campo seja `phone`.
          3. **CRUCIAL**: Crie um campo personalizado OCULTO no seu formulário MailerLite.
             O "Nome do campo" deve ser `event_id_hidden`. O script usará este campo para enviar um ID único ao seu webhook.
        -->
        <section id="mailerliteFormSection" class="mt-8 text-center w-full">
            <div class="ml-embedded" data-form="fnu5le"></div>
        </section>
        <!-- Fim do Formulário MailerLite -->
    </div>

<!-- INÍCIO DO SCRIPT PARA GOOGLE TAG MANAGER -->
<script>
    // Inicia o dataLayer se ele ainda não existir. É uma boa prática para evitar erros.
    window.dataLayer = window.dataLayer || [];

    /**
     * Gera um UUID v4 (Universally Unique Identifier) usando a API de Criptografia do navegador.
     * Essencial para criar um event_id único para cada conversão.
     * @returns {string} Um UUID v4, por exemplo: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
     */
    function generateUUID() {
      return crypto.randomUUID();
    }

    /**
     * Busca o valor de um cookie específico pelo nome.
     * @param {string} name - O nome do cookie a ser buscado (ex: '_fbp', '_fbc').
     * @returns {string|undefined} O valor do cookie ou undefined se não for encontrado.
     */
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return undefined;
    }

    /**
     * Extrai um parâmetro de consulta (query parameter) da URL da página atual.
     * @param {string} name - O nome do parâmetro da URL (ex: 'gclid').
     * @returns {string|null} O valor do parâmetro ou null se não for encontrado.
     */
    function getURLParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    /**
     * Ouve o evento 'ml-embedded:form:load', que é disparado quando o formulário MailerLite é carregado na página.
     * Usamos este evento para encontrar o campo oculto que você criou (`event_id_hidden`) e preenchê-lo
     * com um UUID único. Isso garante que o mesmo ID seja enviado no webhook e no dataLayer.
     */
    document.addEventListener('ml-embedded:form:load', function(event) {
        try {
            // O MailerLite gera IDs dinâmicos, então selecionamos o campo pelo atributo 'name', que é estável.
            const hiddenField = document.querySelector('input[name="fields[event_id_hidden]"]');
            if (hiddenField) {
                const newUUID = generateUUID();
                hiddenField.value = newUUID;
                console.log('Campo oculto event_id preenchido com o valor:', newUUID);
            } else {
                console.warn("Aviso: Campo oculto com nome 'fields[event_id_hidden]' não foi encontrado. O event_id não será enviado no webhook. Verifique se o campo foi criado corretamente no MailerLite.");
            }
        } catch(e) {
            console.error('Erro ao tentar preencher o campo oculto do event_id:', e);
        }
    });

    /**
     * Ouve o evento 'ml-embedded:form:success' da API do MailerLite.
     * Esta é a maneira mais confiável de acionar nosso script, pois ele é executado somente *após*
     * o MailerLite confirmar que o lead foi enviado com sucesso.
     * O callback nos fornece todos os dados que foram enviados no formulário.
     */
    document.addEventListener('ml-embedded:form:success', function(event) {
        try {
            // Os dados do formulário estão na propriedade 'detail.data' do objeto de evento.
            const data = event.detail.data;
            console.log('Formulário enviado com sucesso. Dados recebidos do MailerLite:', data);

            // 1. CAPTURA DOS DADOS DO FORMULÁRIO
            // Os dados vêm diretamente do objeto 'data' fornecido pelo evento.
            const email = data.fields.email || '';
            const name = data.fields.name || '';
            const phone = data.fields.phone || undefined; // Assume que o campo de telefone no MailerLite se chama 'phone'.
            
            // Captura o event_id que foi preenchido no campo oculto. Se falhar, gera um novo como fallback.
            const eventId = data.fields.event_id_hidden || generateUUID();

            // 2. CAPTURA DOS DADOS DE RASTREAMENTO (Cookies e URL)
            const fbp = getCookie('_fbp');
            const fbc = getCookie('_fbc');
            const gclid = getURLParam('gclid');

            // 3. MONTAGEM DO PAYLOAD PARA O DATALAYER
            // Estrutura do objeto conforme solicitado, separando dados do lead e dados do usuário para CAPI.
            const dataLayerPayload = {
                event: 'lead_form_submit',
                event_id: eventId,
                lead_data: {
                    email: email,
                    name: name,
                },
                user_data: {
                    email: email,
                    fbp: fbp,
                    fbc: fbc,
                    gclid: gclid,
                    client_user_agent: navigator.userAgent,
                    client_ip_address: 'AUTO_DETECT', // Será preenchido pelo GTM Server-Side.
                }
            };

            // Adiciona o número de telefone aos objetos 'lead_data' e 'user_data' apenas se ele foi preenchido.
            if (phone) {
                dataLayerPayload.lead_data.phone_number = phone;
                dataLayerPayload.user_data.phone_number = phone;
            }

            // 4. ENVIO PARA O DATALAYER
            // A função push adiciona o evento à fila do dataLayer para o GTM processar.
            window.dataLayer.push(dataLayerPayload);

            console.log('Evento "lead_form_submit" enviado para o dataLayer:', dataLayerPayload);

        } catch (error) {
            console.error('Erro ao processar o envio do formulário para o dataLayer:', error);
        }
    });
</script>
<!-- FIM DO SCRIPT PARA GOOGLE TAG MANAGER -->

</body>
</html>
